name: Build QMK firmware

on: [push, workflow_dispatch]

permissions:
  contents: write

jobs:
  build:
    name: 'QMK Userspace Build'
    uses: qmk/.github/.github/workflows/qmk_userspace_build.yml@main
    with:
      qmk_repo: qmk/qmk_firmware
      qmk_ref: master

  build-goforty:
    name: 'Build goforty_ortho'
    runs-on: ubuntu-latest
    container: ghcr.io/qmk/qmk_cli:latest
    steps:
      - name: Checkout userspace
        uses: actions/checkout@v4

      - name: Checkout QMK Firmware
        uses: actions/checkout@v4
        with:
          repository: qmk/qmk_firmware
          path: qmk_firmware
          submodules: recursive

      - name: Setup keyboard symlink
        run: |
          mkdir -p qmk_firmware/keyboards/salicylic_acid3
          ln -s $GITHUB_WORKSPACE/keyboards/salicylic_acid3/goforty_ortho qmk_firmware/keyboards/salicylic_acid3/goforty_ortho

      - name: Build firmware
        run: |
          qmk config user.qmk_home=$GITHUB_WORKSPACE/qmk_firmware
          qmk config user.overlay_dir=$GITHUB_WORKSPACE
          qmk compile -kb salicylic_acid3/goforty_ortho -km roy

      - name: Upload firmware
        uses: actions/upload-artifact@v4
        with:
          name: Firmware-goforty
          path: qmk_firmware/salicylic_acid3_goforty_ortho_roy.uf2

  generate-keymap-images:
    name: 'Generate Keymap Images'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install keymap-drawer
        run: pip install keymap-drawer

      - name: Generate SVG and PNG
        run: |
          cd keyboards/planck/keymaps/roy
          keymap draw keymap.yaml -o my_keymap.svg
          npx @resvg/resvg-js-cli my_keymap.svg keymap.png

      - name: Upload keymap images
        uses: actions/upload-artifact@v4
        with:
          name: Keymap-Images
          path: |
            keyboards/planck/keymaps/roy/my_keymap.svg
            keyboards/planck/keymaps/roy/keymap.png

  publish:
    name: 'QMK Userspace Publish'
    uses: qmk/.github/.github/workflows/qmk_userspace_publish.yml@main
    if: always() && !cancelled()
    needs: build

  add-assets-to-release:
    name: 'Add Extra Assets to Release'
    runs-on: ubuntu-latest
    needs: [publish, build-goforty, generate-keymap-images]
    if: always() && !cancelled() && needs.publish.result == 'success'
    steps:
      - name: Download goforty firmware
        uses: actions/download-artifact@v4
        with:
          name: Firmware-goforty
          path: firmware

      - name: Download keymap images
        uses: actions/download-artifact@v4
        with:
          name: Keymap-Images
          path: images

      - name: Upload assets to release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release upload latest firmware/*.uf2 --repo ${{ github.repository }} --clobber
          gh release upload latest images/*.svg images/*.png --repo ${{ github.repository }} --clobber

      - name: Add keymap image to release notes
        env:
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
        run: |
          CURRENT_BODY=$(gh release view latest --repo "$REPO" --json body -q '.body')
          IMAGE_URL="https://github.com/${REPO}/releases/download/latest/keymap.png"
          NEW_BODY=$(printf '%s\n\n## Keymap\n![Keymap](%s)' "$CURRENT_BODY" "$IMAGE_URL")
          gh release edit latest --repo "$REPO" --notes "$NEW_BODY"
